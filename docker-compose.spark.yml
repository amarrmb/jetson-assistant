# DGX Spark — Best UX, Full Pipeline
# 7B VLM + Kokoro TTS + Nemotron STT (128GB unified memory, Blackwell GB10)
#
# Usage: docker compose -f docker-compose.spark.yml up -d
#
# Audio options:
#   # Auto-detect USB audio (default)
#   docker compose -f docker-compose.spark.yml up -d
#
#   # PipeWire passthrough (Bluetooth + system defaults)
#   AUDIO_UID=$(id -u) docker compose -f docker-compose.spark.yml up -d
#
#   # Manual card override
#   ALSA_CARD=USB docker compose -f docker-compose.spark.yml up -d
#
# Build locally:
#   docker compose -f docker-compose.spark.yml build
#
# Check readiness:
#   curl http://localhost:8001/v1/models
#
# Note on vLLM image:
#   Uses the Jetson Thor vLLM build (same SBSA ARM64 + CUDA 13.0 arch).
#   If this doesn't work on your DGX Spark, alternatives:
#     - pip install vllm inside an NGC PyTorch container
#     - nvcr.io/nvidia/pytorch:25.01-py3 with vllm installed

x-common: &common
  runtime: nvidia
  network_mode: host
  ipc: host
  restart: unless-stopped
  ulimits:
    memlock: -1
    stack: 67108864

volumes:
  hf-cache:

services:
  vllm:
    <<: *common
    image: ghcr.io/nvidia-ai-iot/vllm:latest-jetson-thor
    container_name: assistant-vllm
    volumes:
      - hf-cache:/root/.cache/huggingface
    command: >
      vllm serve nvidia/Qwen2.5-VL-7B-Instruct-NVFP4
      --host 0.0.0.0 --port 8001
      --max-model-len 4096
      --gpu-memory-utilization 0.3
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8001/v1/models"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 300s

  assistant:
    <<: *common
    image: ghcr.io/amarrmb/jetson-assistant:spark
    build:
      context: .
      args:
        PLATFORM: spark
    container_name: assistant
    devices:
      - /dev/snd
    device_cgroup_rules:
      - 'c 81:* rmw'
    volumes:
      - /dev:/dev
      - hf-cache:/root/.cache/huggingface
      # PipeWire passthrough (optional — enables Bluetooth + system defaults)
      # Set AUDIO_UID to your user ID to enable, or omit for ALSA-only mode
      - /run/user/${AUDIO_UID:-65534}:/run/user/${AUDIO_UID:-65534}
    environment:
      - TORCH_COMPILE_DISABLE=1
      - ALSA_CARD=${ALSA_CARD:-}  # Optional: auto-detected if empty
      # XDG_RUNTIME_DIR is required for PipeWire passthrough (Tier 1).
      - XDG_RUNTIME_DIR=/run/user/${AUDIO_UID:-65534}
    depends_on:
      vllm:
        condition: service_healthy
    command: ["assistant", "--config", "configs/spark.yaml"]
